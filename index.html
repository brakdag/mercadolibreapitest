<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Estadísticas de Mercadolibre</title>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
</head>

<body>
	<div class="container">
		<div id="espacio">
		<br/><br/><br/><br/><br/><br/>
		</div>
		<div id='row' class="row text-center col-md-8 col-md-offset-2">
			<img id="logo" src="img/logo.png" width="20%">
			<div  class="input-group">
				<input class="form-control" id="q" placeholder="Ingrese su búsqueda" type="text">
      			<span class="input-group-btn">
        		<button class="btn btn-default" id="boton1"><span aria-hidden="true" class="glyphicon glyphicon-search"></span>  Buscar</button></span>
			</div>
			<button id="descargar" class="hide col-md-2 col-md-offet-2 btn btn-success">Descargar CSV
			</button>	
 
 			<div id='advertencia'> <br/><br/> <p style="color:gray;">verifique que posee CORS para chrome, <a href="https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi">aquí</a> y actívela</p></div>
  		</div>
 
  	</div>	
<div id="progreso"></div>
<div id="tabla">
</div>



<script>
var total =0;
var limit =0;
var datos;
var url_call1 = "https://api.mercadolibre.com/sites/MLA/search?q="+ $("#q").val() +"&limit=1"
var url_call = "https://api.mercadolibre.com/sites/MLA/search?q="+ $("#q").val() +"&limit=200&offset="
$("#descargar").click(function(){
	exportar(datos);
});




function exportar(data) {
            
            if (navigator.appName == 'Microsoft Internet Explorer') {
                
                var popup = window.open('','csv','');
                popup.document.body.innerHTML = '<pre>' + data + '</pre>';
 
            }else{

           var link = document.createElement('a');
    	   link.download = "datos.csv";
    	   link.href = 'data:text/csv; charset=utf8,' + encodeURIComponent(data);
           link.click();
             
        //        location.href='data:text/csv; charset=utf8,' + encodeURIComponent(data);
                
            }
 
            
            return true;
            
            
        }
$("#q").keypress(function(e) {
	$("#logo").hide(200);
	$("#advertencia").hide(200);
	$("#espacio").hide(200);
    $('#row').removeClass('col-md-offset-2');
    if(e.which == 13) {
        $("#boton1").click();
    }
    

});


	$("#boton1").click(function(){
	var URLactual = window.location;
	console.log(URLactual.href);
	//	if (URLactual.href!="https://brakdag.github.io/mercadolibreapitest/"){$("#q").val("");}

		url_call1 = "https://api.mercadolibre.com/sites/MLA/search?q="+ $("#q").val() +"&limit=1";
		url_call = "https://api.mercadolibre.com/sites/MLA/search?q="+ $("#q").val() +"&limit=200&offset=";
		datos = "";
		$.get( url_call1, function( data ) {
    		limit = 200;
    		total = parseInt(data.paging.total);
            sturges = Math.trunc(1+Math.log(total));
    		$("#tabla").text( "Número de resultados: " + total + " intervalos: " + sturges ); 

    		for(var j=0;j<(Math.trunc(total/limit));j++)
    		{

    			$("#progreso").text( j*limit/total*100 + "%");

    			console.log(url_call +j*limit);
	    		$.get( url_call+(j*limit), function( data2 ) {
			    		for (var i=0 ; i<limit; i++) 
			    		{
			    			try{
			    			datos = datos + data2.results[i].id + "\t" + data2.results[i].title + "\t" + data2.results[i].price + "\r\n";
							}
							catch(err){
						    datos = datos + "error:" + err +  "\r\n"; 	
							}
			    						    	}
				});
	    	}

	$.get( url_call+(total-total % limit), function( data2 ) {
				limit = parseInt(data2.paging.limit);
			    for (var i=0 ; i<(total % limit); i++) 
			    		{
			    			try{
			    			datos = datos + data2.results[i].id + "\t" + data2.results[i].title + "\t" + data2.results[i].price + "\r\n"; 
			    			
							}
							catch(err){
						    datos = datos + "error:" + err +  "\r\n"; 	
							}
			    		}

			    });
     $("#progreso").text("100%");
	    console.log("fin");
	  $('#descargar').removeClass('hide');
	  $('#descargar').addClass('show');
	  

	});
});


</script>
<!--  Scripts cargados de urls-->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</body>
</html>