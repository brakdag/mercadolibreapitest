<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Estadísticas de Mercadolibre</title>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
</head>

<body>
	<div class="container">
		<div id="espacio">
		<br/><br/><br/><br/><br/><br/>
		</div>
		<div id='row' class="row text-center col-md-8 col-md-offset-2">
			<img id="logo" src="img/logo.png" width="20%">
			<div  class="input-group">
				<input class="form-control" id="q" placeholder="Ingrese su búsqueda" type="text">
      			<span class="input-group-btn">
        		<button class="btn btn-default" id="boton1"><span aria-hidden="true" class="glyphicon glyphicon-search"></span>  Buscar</button></span>
			</div>
			<button id="descargar" class="hide col-md-2 col-md-offet-2 btn btn-success">Descargar CSV
			</button>	
 
 			<div id='advertencia'> <br/><br/> <p style="color:gray;">verifique que posee CORS <a href="https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi">Chrome</a> o <a href="https://addons.mozilla.org/es/firefox/addon/cross-domain-cors/">Firefox</a> y actívela</p></div>
  		</div>
  	</div>
  	<div id='row' class="row text-center col-md-4 col-md-offset-4">
<canvas id="myChart" width="400px" height="400px"></canvas> 
</div>			
<div id="progreso"></div>
<div id="tabla"></div>
<div id="media"></div>
<div witdh="50%">

    </div>


<script>
var ctx = document.getElementById("myChart");
var total =0;
var limit =0;
var datos;
var precios = [];
var sturges;
var intervalo;
var pregunta;
var url_call1 = "https://api.mercadolibre.com/sites/MLA/search?q="+ $("#q").val() +"&limit=1"
var url_call = "https://api.mercadolibre.com/sites/MLA/search?q="+ $("#q").val() +"&limit=200&offset="
$("#descargar").click(function(){
	exportar(datos);
});

$(document).ready(function () {

     });


function exportar(data) {
            
            if (navigator.appName == 'Microsoft Internet Explorer') {
                
                var popup = window.open('','csv','');
                popup.document.body.innerHTML = '<pre>' + data + '</pre>';
 
            }else{

           var link = document.createElement('a');
    	   link.download = "datos.csv";
    	   link.href = 'data:text/csv; charset=utf8,' + encodeURIComponent(data);
           link.click();
             
        //        location.href='data:text/csv; charset=utf8,' + encodeURIComponent(data);
                
            }
 
            
            return true;
            
            
        }
$("#q").keypress(function(e) {
	$("#logo").hide(200);
	$("#advertencia").hide(200);
	$("#espacio").hide(200);
    $('#row').removeClass('col-md-offset-2');
    if(e.which == 13) {
        $("#boton1").click();
    }
});


	$("#boton1").click(function(){
	var URLactual = window.location;
	console.log(URLactual.href);
	//	if (URLactual.href!="https://brakdag.github.io/mercadolibreapitest/"){$("#q").val("");}
		pregunta = $("#q").val();
		url_call1 = "https://api.mercadolibre.com/sites/MLA/search?q="+ $("#q").val() +"&limit=1";
		url_call = "https://api.mercadolibre.com/sites/MLA/search?q="+ $("#q").val() +"&limit=200&offset=";
		datos = "";
		$.get( url_call1, function( data ) {
    		limit = 200;
    		total = parseInt(data.paging.total);
            sturges = Math.trunc(1+Math.log(total));
    		$("#tabla").text( "Número de resultados: " + total + " intervalos: " + sturges ); 


    		for(var j=0;j<(Math.trunc(total/limit));j++)
    		{

    			$("#progreso").text( j*limit/total*100 + "%");

    			console.log(url_call +j*limit);

	    		$.get( url_call+(j*limit), function( data2 ) {
			    		for (var i=0 ; i<limit; i++) 
			    		{
			    			try{
			    			datos = datos + data2.results[i].id + "\t" + data2.results[i].title + "\t" + data2.results[i].price + "\r\n"; 
			    			precios.push( parseFloat(data2.results[i].price));
							}
							catch(err){
						    datos = datos + "error:" + err +  "\r\n"; 	
							}
			    						    	}
				});
	    	}

	$.get( url_call+(total-total % limit), function( data2 ) {
				limit = parseInt(data2.paging.limit);
			    for (var i=0 ; i<(total % limit); i++) 
			    		{
			    			try{
			    			datos = datos + data2.results[i].id + "\t" + data2.results[i].title + "\t" + data2.results[i].price + "\r\n"; 
			    			precios.push( parseFloat(data2.results[i].price));
							}
							catch(err){
						    datos = datos + "error:" + err +  "\r\n"; 
							}
			    		}
	
  var suma=0;
  var suma_cuad=0;
  // calcula la media
       for(var i=0;i<precios.length;i++)
       {
       		suma += precios[i];
       }
var media = suma/precios.length*2;
// calcula la varianza
	for(var i=0;i<precios.length;i++)
       {
       		suma_cuad += Math.pow(precios[i]-media,2);
       }
        
       var varianza = suma_cuad/precios.length;
       var desviacion = Math.round(Math.sqrt(varianza)*100)/100;
       $("#media").text('Media: '+ Math.round(media*100)/100 + '$ desviacion: ' + desviacion +'$');
	  
     intervalo = new Array(sturges);
    var marcadeclase = new Array(sturges);
     for(var i=0;i<sturges;i++) intervalo[i]=0;
       var c = media*2/sturges;
	for(var i=0;i<sturges;i++) marcadeclase[i]= Math.round(c*(i+1)/2*100)/100 + "$";
     
       for(var i=0 ; i < precios.length; i++){
       		for(var j=0 ;j<sturges;j++)
       		{
       			if ((precios[i]>(c*j)) && ( precios[i] < ( c * (j+1) ))){
       				intervalo[j]++;
       			}
       		}
       }

var myChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: marcadeclase,
        datasets: [{
            data: intervalo,
            borderWidth: 2
        }]
    }
    
});


			 });


     $("#progreso").text("100%");  
	 $('#descargar').removeClass('hide');
	 $('#descargar').addClass('show');

     


	});
});


</script>
<!--  Scripts cargados de urls-->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</body>
</html>